#!groovy

@Library("Infrastructure")

import uk.gov.hmcts.contino.AppPipelineConfig

def type = "nodejs"
def product = "wa"
def component = "task-batch-service"

def yarnBuilder = new uk.gov.hmcts.contino.YarnBuilder(this)


def secrets = [
  's2s-${env}': [
    secret('microservicekey-wa-task-monitor', 'S2S_SECRET_TASK_MONITOR')
  ]
]

static LinkedHashMap<String, Object> secret(String secretName, String envVar) {
  [$class     : 'AzureKeyVaultSecret',
   secretType : 'Secret',
   name       : secretName,
   version    : '',
   envVariable: envVar
  ]
}

def pipelineConf = new AppPipelineConfig()
pipelineConf.vaultSecrets = secrets

withPipeline(type, product, component) {
  disableLegacyDeployment()
  nonServiceApp()
  loadVaultSecrets(secrets)

  before('test') {
    setupSecretsForFunctionalTests(pipelineConf)
  }


  onPR {
    env.S2S_URL = "http://rpe-service-auth-provider-aat.service.core-compute-aat.internal"
    env.WA_TASK_MONITOR_SERVICE_URL = "http://wa-task-monitor-aat.service.core-compute-aat.internal"
    env.S2S_MICROSERVICE_NAME_TASK_MONITOR = "wa_task_monitor"
    env.JOB_NAME = "INITIATION"
  }

}

def setupSecretsForFunctionalTests(pipelineConf) {
  withSubscription('nonprod') {
    withTeamSecrets(pipelineConf, 'aat') {
      env.S2S_SECRET_TASK_MONITOR = "${S2S_SECRET_TASK_MONITOR}"
    }
  }
}



